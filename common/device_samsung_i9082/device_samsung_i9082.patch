From 45c5352b9ea8f6dc8c47e358fba52b025a6f9f7a Mon Sep 17 00:00:00 2001
From: Pawit Pornkitprasan <p.pawit@gmail.com>
Date: Sun, 16 Nov 2014 14:35:10 +0700
Subject: [PATCH] i9082: WIP: lollipop

Change-Id: I4897e6d948e546d48defc99d57dff3d27aa5a704
---
 BoardConfig.mk                                     |  6 ++++
 init.capri_ss_baffin.rc                            |  1 +
 sepolicy/device.te                                 |  1 +
 sepolicy/file_contexts                             | 24 +++++++++++++--
 sepolicy/init.te                                   |  7 +++++
 sepolicy/kernel.te                                 |  6 ++++
 sepolicy/property_contexts                         |  1 +
 sepolicy/rild.te                                   |  9 ++++++
 sepolicy/system_server.te                          |  2 ++
 15 files changed, 63 insertions(+), 77 deletions(-)
 create mode 100644 sepolicy/device.te
 create mode 100644 sepolicy/init.te
 create mode 100644 sepolicy/kernel.te
 create mode 100644 sepolicy/property_contexts
 create mode 100644 sepolicy/rild.te
 create mode 100644 sepolicy/system_server.te

diff --git a/BoardConfig.mk b/BoardConfig.mk
index ff49784..8feab91 100644
--- a/BoardConfig.mk
+++ b/BoardConfig.mk
@@ -115,3 +115,9 @@ BOARD_SEPOLICY_DIRS += \
 
 BOARD_SEPOLICY_UNION += \
     file_contexts \
+    property_contexts \
+    device.te \
+    init.te \
+    kernel.te \
+    rild.te \
+    system_server.te \

diff --git a/init.capri_ss_baffin.rc b/init.capri_ss_baffin.rc
index f1440fb..3b17e2e 100755
--- a/init.capri_ss_baffin.rc
+++ b/init.capri_ss_baffin.rc
@@ -444,6 +444,7 @@ on fs
     chown system radio /sys/class/sec/switch/adc
 
 on post-fs
+    restorecon_recursive /efs
     chown radio system /efs
     chmod 0771 /efs

diff --git a/sepolicy/device.te b/sepolicy/device.te
new file mode 100644
index 0000000..c185d01
--- /dev/null
+++ b/sepolicy/device.te
@@ -0,0 +1 @@
+type cam_block_device, dev_type;
diff --git a/sepolicy/file_contexts b/sepolicy/file_contexts
index 9628eab..9ea68b3 100644
--- a/sepolicy/file_contexts
+++ b/sepolicy/file_contexts
@@ -1,3 +1,21 @@
-# Graphics
-/dev/vchiq                                          u:object_r:powervr_device:s0
-/dev/vc-lmk                                         u:object_r:powervr_device:s0
+/dev/vchiq                                          u:object_r:gpu_device:s0
+/dev/vc-lmk                                         u:object_r:gpu_device:s0
+/dev/vcsm                                           u:object_r:gpu_device:s0
+/dev/vc-dnfo                                        u:object_r:gpu_device:s0
+/dev/vc-omx                                         u:object_r:video_device:s0
+/dev/vc-cma                                         u:object_r:video_device:s0
+
+/dev/bcm_irpc                                       u:object_r:radio_device:s0
+/dev/mpu6k                                          u:object_r:sensors_device:s0
+/dev/proximity                                      u:object_r:sensors_device:s0
+
+/efs/bluetooth/bt_addr                              u:object_r:bluetooth_efs_file:s0
+/sys/devices/platform/bcmbt-rfkill.1/rfkill/rfkill0/state -- u:object_r:sysfs_bluetooth_writable:s0
+/sys/devices/platform/bcmbt-rfkill.1/rfkill/rfkill0/type -- u:object_r:sysfs_bluetooth_writable:s0
+
+/dev/ttyS2                                          u:object_r:hci_attach_dev:s0
+
+/dev/bcm_log                                        u:object_r:radio_device:s0
+/dev/block/mmcblk0p1                                u:object_r:radio_device:s0
+
+/dev/block/mmcblk0p15                               u:object_r:cam_block_device:s0
diff --git a/sepolicy/init.te b/sepolicy/init.te
new file mode 100644
index 0000000..45989e3
--- /dev/null
+++ b/sepolicy/init.te
@@ -0,0 +1,7 @@
+# chmod in init.capri_ss_baffin.rc (for bkmgrd)
+allow init block_device:blk_file setattr;
+allow init kmem_device:chr_file setattr; # TODO: want read and open too, but conflicts with neverallow
+allow init radio_device:blk_file setattr;
+
+# insmod
+allow init self:capability sys_module; # TODO: want sys_ptrace too
diff --git a/sepolicy/kernel.te b/sepolicy/kernel.te
new file mode 100644
index 0000000..97173fe
--- /dev/null
+++ b/sepolicy/kernel.te
@@ -0,0 +1,6 @@
+# Create mmcblk1
+allow kernel device:blk_file { create setattr };
+allow kernel self:capability mknod;
+
+# kcamfwcheck drivers/char/broadcom/vc_cam/vc_cam.c
+allow kernel cam_block_device:blk_file rw_file_perms;
diff --git a/sepolicy/property_contexts b/sepolicy/property_contexts
new file mode 100644
index 0000000..c74a4bb
--- /dev/null
+++ b/sepolicy/property_contexts
@@ -0,0 +1 @@
+service.brcm.bt.mac     u:object_r:radio_prop:s0
diff --git a/sepolicy/rild.te b/sepolicy/rild.te
new file mode 100644
index 0000000..c92f260
--- /dev/null
+++ b/sepolicy/rild.te
@@ -0,0 +1,9 @@
+allow rild self:capability dac_override;
+
+allow rild gps_data_file:fifo_file { write read open setattr };
+allow rild self:packet_socket { create ioctl };
+allow rild system_data_file:sock_file { create setattr unlink };
+allow rild system_data_file:dir rw_dir_perms;
+
+# /proc/bcm_fuse_net_config
+allow rild proc:file write;
diff --git a/sepolicy/system_server.te b/sepolicy/system_server.te
new file mode 100644
index 0000000..7782f3d
--- /dev/null
+++ b/sepolicy/system_server.te
@@ -0,0 +1,2 @@
+# Access /efs/wifi/.mac.info
+allow system_server efs_file:file { read open };
-- 
1.9.3 (Apple Git-50)

